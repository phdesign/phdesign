




<!DOCTYPE html>
<html lang="en">
  
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Paul Heasley">
  

  <title>Increment project version from Travis | phdesign</title>

  <!-- Google Web Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Favicon/Touch Icons  -->
  <link rel="shortcut icon" href="/favicon.ico">
  <!-- <link rel="apple-touch-icon" href="/assets/img/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/apple-touch-icon-114x114.png"> -->

  <!-- Tell Google this page is under test - index original version -->
  <link rel="canonical" href="http://www.phdesign.com.au/programming/auto-increment-project-version-from-travis/">

</head>

  <body class="post">

    <div class="header-background-image"></div>
    <header role="banner">
      <div class="header-top">
        
<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/" title="phdesign homepage">ph<span class="brand-muted">design</span></a>
    </div><!-- end .navbar-header -->

    <div class="collapse navbar-collapse" id="navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/">Home <span class="sr-only">(current)</span></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Blog <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            
              <li><a href="/programming">programming</a></li>
            
              <li><a href="/general">general</a></li>
            
              <li><a href="/woodworking">woodworking</a></li>
            
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Projects <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/phreplace">phReplace</a></li>
            <li><a href="/npptoolbucket">NppToolBucket</a></li>
            <li><a href="/betternote">BetterNote</a></li>
          </ul>
        </li>
        <li><a href="/contact">Contact me</a></li>
      </ul>

      

    </div><!-- end .navbar-collapse -->
  </div><!-- end .container -->
</nav>

      </div><!-- end .header-top -->

      

    </header>

    <main class="content">
      <article>
  <div class="container">

    

    <div class="date-stamp">
      <div class="month">Nov</div>
      <div class="day">29</div>
    </div><!-- end .date-stamp -->

    <h2 class="post-header">Increment project version from Travis</h2>

    <div class="meta-label">
      posted on <span class="meta-value muted">29 November 2016</span>
      
        in <span class="meta-value"><a href="/programming">programming</a></span>
      
      with <span class="meta-value"><a data-disqus-identifier="increment-project-version-from-travis" href="#disqus_thread">0 Comments</a></span>
    </div><!-- end .meta-label -->
    <br />

    
    
    
    

    <p>Can you effectively use <a href="https://github.com">GitHub</a> and <a href="https://travis-ci.org">Travis</a> for continuous delivery? You sure can, but managing the version number can be difficult, here’s a way to automatically increment the patch number on every deployment from Travis.</p>

<!--more-->

<p>We use a <a href="https://gist.github.com/seshness/3943237">shared repository model</a> for our JavaScript project on GitHub, the workflow goes something like this:</p>

<ul>
  <li>The <code>master</code> branch is always the currently deployed production code</li>
  <li>When someone wants to add a new feature or fix a bug, they create a branch (both locally and on GitHub)</li>
  <li>Travis builds all commits to all branches and runs the continuous integration test suite</li>
  <li>Once development is complete and tests pass they open a Pull Request</li>
  <li>Once someone has approved the Pull Request (we love the new functionality - thanks GitHub!), they then merge and squash onto <code>master</code></li>
  <li>Travis builds all commits onto the <code>master</code> branch, if tests pass it deploys the package to a private <a href="https://www.npmjs.com/">npm</a> repository and deploys the artefacts to S3</li>
</ul>

<p>The trick is that the version number in the <code>package.json</code> file must be updated on every commit to master otherwise npm will reject it (rightly so). We used to manually update this before merging the Pull Request by doing an <code>npm version patch</code>, but people forget to do this or they do it too early and get merge conflicts.</p>

<p>We now automate incrementing the version by using git tags. Before Travis builds the project, it pulls the latest git tag, then compares the major and minor version (x.x.0) to what’s in <code>package.json</code>. If they match it increments the patch version (0.0.x) and creates a new git tag and updates the package.json file, if they don’t match we assume the developer has incremented either the minor or major version and so it resets the patch number to 0. At the end of a successful build on the master branch, the tag is pushed back to GitHub. This ensures a nice history of every commit on master having a git tag of the version number, which supports our continuous delivery workflow.</p>

<p>Here’s the relevant <code>.travis.yaml</code> entries to make this work:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># This is needed to avoid building all the tags pushed by travis</span>
<span class="l-Scalar-Plain">branches</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">except</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/^v?\d+\.\d+\.\d+$/</span>

<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="c1"># Create a git tag of the new version to use</span>
  <span class="c1"># If package.json major and minor versions match last tag, then increment last tag. Else use package.json major.minor.0.</span>
<span class="p-Indicator">-</span> <span class="s">&quot;{</span><span class="nv"> </span><span class="s">sed</span><span class="nv"> </span><span class="s">-nE</span><span class="nv"> </span><span class="s">&#39;s/^[</span><span class="nv"> </span><span class="s">\\t]*\&quot;version\&quot;:</span><span class="nv"> </span><span class="s">\&quot;([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\&quot;,$/\\1/p&#39;</span><span class="nv"> </span><span class="s">package.json;</span><span class="nv"> </span><span class="s">git</span><span class="nv"> </span><span class="s">describe</span><span class="nv"> </span><span class="s">--abbrev=0</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">sed</span><span class="nv"> </span><span class="s">-E</span><span class="nv"> </span><span class="s">&#39;s/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1</span><span class="nv"> </span><span class="s">\\2/g&#39;;</span><span class="nv"> </span><span class="s">}</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">tr</span><span class="nv"> </span><span class="s">\&quot;\\n\&quot;</span><span class="nv"> </span><span class="s">\&quot;</span><span class="nv"> </span><span class="s">\&quot;</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">awk</span><span class="nv"> </span><span class="s">&#39;{printf($1==$2?\&quot;v\&quot;$2$3+1:\&quot;v\&quot;$1\&quot;0\&quot;)}&#39;</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">xargs</span><span class="nv"> </span><span class="s">-I</span><span class="nv"> </span><span class="s">{}</span><span class="nv"> </span><span class="s">git</span><span class="nv"> </span><span class="s">tag</span><span class="nv"> </span><span class="s">-a</span><span class="nv"> </span><span class="s">{}</span><span class="nv"> </span><span class="s">-m</span><span class="nv"> </span><span class="s">\&quot;{}\&quot;\n&quot;</span>
  <span class="c1"># Update package.json based on the git tag we just created</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">npm --no-git-tag-version version from-git</span>

<span class="c1"># Push the new tag back to GitHub but only if on the master branch</span>
<span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">script</span>
    <span class="l-Scalar-Plain">skip_cleanup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git push --tags</span>
    <span class="l-Scalar-Plain">on</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">branch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">master</span></code></pre></div>

<p>Let’s decompose that bash one-liner:</p>

<ol>
  <li>
    <p>Read the current major and minor version from package.json (e.g. <code>1.2</code>)</p>

    <pre><code> sed -nE 's/^[ \\t]*"version": "([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}",$/\\1/p' package.json;
</code></pre>
  </li>
  <li>
    <p>Get the latest git tag (e.g. <code>v1.2.43</code>)</p>

    <pre><code> git describe --abbrev=0
</code></pre>
  </li>
  <li>
    <p>Split out the major and minor version and the patch version into separate parts (e.g. <code>1.2 43</code>)</p>

    <pre><code> sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g';
</code></pre>
  </li>
  <li>
    <p>Take the output of 1. and 2. and create 3 space separated parts which are (in order) <code>&lt;major.minor from package.json&gt; &lt;major.minor from git tag&gt; &lt;patch from git tag&gt;</code></p>

    <pre><code> tr "\\n" " "
</code></pre>
  </li>
  <li>
    <p>If part 1 and 2 match, just increment the patch version, otherwise use major.minor from package.json and reset patch to 0.</p>

    <pre><code> awk '{printf($1==$2?"v"$2$3+1:"v"$1"0")}'
</code></pre>
  </li>
  <li>
    <p>Pipe the resulting version number into a git tag (e.g. <code>v1.2.44</code>)</p>

    <pre><code> xargs -I {} git tag -a {} -m "{}"
</code></pre>
  </li>
</ol>


    <ul class="post-tags">
      
        <li><a href="/tag/travis" title="View posts tagged with travis">#travis</a></li>
      
        <li><a href="/tag/github" title="View posts tagged with github">#github</a></li>
      
        <li><a href="/tag/npm" title="View posts tagged with npm">#npm</a></li>
      
    </ul>

    

  </div><!-- end .container -->
</article>

<div class="stripe">
  <div class="container">

    <div class="comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'phdesign';
        var disqus_identifier = 'increment-project-version-from-travis';
        var disqus_title = 'Increment project version from Travis';
        var disqus_url = 'http://phdesign.com.au/programming/auto-increment-project-version-from-travis/';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div><!-- end .comments -->

  </div><!-- end .container -->
</div>

<div class="stripe alt">
  <div class="container">

    <nav class="row pager">
      <div class="previous col-xs-6 col-sm-4">
        
          <div class="meta-label"><a href="/general/adding-font-awesome-icons-to-google-slides/"><span aria-hidden="true">&laquo;</span> Previous post</a></div>
          <div class="meta-value"><a href="/general/adding-font-awesome-icons-to-google-slides/">Adding font-awesome (or any SVG) to Google Slides</a></div>
        
      </div>
      <div class="next col-xs-6 col-sm-4 col-sm-offset-4">
        
          <div class="meta-label"><a href="/programming/starting-a-promise-chain-to-handle-exceptions-correctly/">Next post <span aria-hidden="true">&raquo;</span></a></div>
          <div class="meta-value"><a href="/programming/starting-a-promise-chain-to-handle-exceptions-correctly/">Starting a promise chain to handle exceptions correctly</a></div>
        
      </div>
    </nav><!-- end .post_nav -->

  </div><!-- end .container -->
</div><!-- end .stripe.alt -->

    </main><!-- end .content -->

    
<footer role="contentinfo">
  <div class="container">

    <ul class="social-icons">
      <li><a href="https://twitter.com/pheasley" title="Follow me on Twitter"><i class="fa fa-twitter"></i></a></li>
      <li><a href="https://github.com/phdesign" title="See my code on GitHub"><i class="fa fa-github"></i></a></li>
      <li><a href="https://au.linkedin.com/in/pheasley" title="Connect with me on LinkedIn"><i class="fa fa-linkedin"></i></a></li>
      <li><a href="https://www.pinterest.com/paulheasley/" title="Follow me on Pinterest"><i class="fa fa-pinterest"></i></a></li>
      <li><a href="https://instagram.com/phdesign/" title="Me on Instagram"><i class="fa fa-instagram"></i></a></li>
    </ul>

    <p class="footer-copyright">
      &copy; 2015 Paul Heasley. All rights reserved. <br>
      Based on a <a href="http://guuthemes.com/" title="Much of the design of this site was based on a GuuThemes theme, big credit to their team for their beautiful art and clean code">GuuTheme</a>.
    </p>

  </div><!-- end .container -->
</footer>

    
<!-- JS (Javascript Files)
================================================== -->

<script src="/assets/js/main.js"></script>

<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = 'phdesign';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2414000-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>

</html>
